<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>JUST COM — แคตตาล็อกสินค้า</title>
<meta name="description" content="หน้ารวมสินค้า JUST COM พร้อมค้นหา แยกหมวด ป้ายขายแล้ว และปุ่มสั่งซื้อเด้งไปแชทเพจ">
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0f1114;--card:#151a1f;--muted:#93a1b3;--line:#222a33;--white:#eaf0f7;--radius:16px;--gap:16px;--maxw:1200px;}
*{box-sizing:border-box}html,body{margin:0;font-family:'Prompt',ui-sans-serif,system-ui,'Segoe UI',Roboto,'Noto Sans Thai',sans-serif;background:var(--bg);color:var(--white)}
a{color:inherit;text-decoration:none}
header{position:sticky;top:0;z-index:10;background:rgba(15,17,20,.75);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--line)}
.wrap{max-width:var(--maxw);margin:0 auto;padding:var(--gap)}
.controls{display:flex;gap:var(--gap);flex-wrap:wrap}
input,select{flex:1;min-width:150px;font-size:1rem;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--white);font-family:inherit}
input::placeholder{color:var(--muted)}
#grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:var(--gap);padding-top:var(--gap)}
.item{background:var(--card);border-radius:var(--radius);overflow:hidden;border:1px solid var(--line);position:relative;display:flex;flex-direction:column}
.item.sold{opacity:.6}
.badge{position:absolute;top:10px;left:10px;z-index:2;background:crimson;color:#fff;font-weight:600;padding:4px 10px;border-radius:8px;font-size:.9rem}
.img{aspect-ratio:4/3;background:var(--bg);overflow:hidden}
.img img{width:100%;height:100%;object-fit:cover;transition:transform .3s}
.item:hover .img img{transform:scale(1.05)}
.body{padding:var(--gap);display:flex;flex-direction:column;flex-grow:1}
.name{font-size:1.1rem;font-weight:500;margin:0 0 4px;line-height:1.4}
.spec{color:var(--muted);font-size:.9rem;margin-bottom:12px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:2.5em}
.price{font-size:1.5rem;font-weight:600;margin-top:auto}
.price span{font-size:1rem;font-weight:400;color:var(--muted)}
.foot{display:flex;gap:8px;padding:var(--gap);border-top:1px solid var(--line);padding-top:12px;margin-top:12px}
.foot a{flex:1;text-align:center;padding:10px;border-radius:10px;font-weight:500;transition:background .2s}
.details{background:var(--line)}
.details:hover{background:rgba(255,255,255,.1)}
.buy{background:#1877f2}
.buy:hover{background:#3a8bfa}
.loader{text-align:center;padding:50px;font-size:1.2rem;color:var(--muted)}
.cat-list{display:flex;flex-wrap:wrap;gap:10px;padding-bottom:var(--gap)}
.cat-btn{background:var(--card);border:1px solid var(--line);color:var(--white);padding:8px 16px;border-radius:10px;cursor:pointer;font-size:.9rem}
.cat-btn.active{background:var(--white);color:var(--bg);font-weight:500}
footer{text-align:center;padding:var(--gap);color:var(--muted);font-size:.9rem;border-top:1px solid var(--line);margin-top:var(--gap)}
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="controls">
      <input type="search" id="q" placeholder="ค้นหาสินค้า...">
      <select id="cat"><option value="">ทุกหมวดหมู่</option></select>
      <select id="status">
        <option value="">ทุกสถานะ</option>
        <option value="active">มีสินค้า (Active)</option>
        <option value="sold">ขายแล้ว (Sold)</option>
        <option value="hidden">ซ่อน (Hidden)</option>
      </select>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="cat-list" class="cat-list"></div>
  <div id="grid"></div>
  <div id="loader" class="loader">กำลังโหลดข้อมูลสินค้า...</div>
</main>

<footer>
  JUST COM &copy; 2025
</footer>

<script>
  const CSV_URL = 'justcom_inventory.csv';
  const q = document.getElementById('q');
  const cat = document.getElementById('cat');
  const status = document.getElementById('status');
  const grid = document.getElementById('grid');
  const loader = document.getElementById('loader');
  const catList = document.getElementById('cat-list');
  let ALL_ITEMS = [];

  function parseCSV(text) {
    // แก้ไขจาก .split('\\n') เป็น .split('\\n').join('\\n').split('\\n') เพื่อแก้ปัญหาการแบ่งบรรทัดที่ต่างกัน
    const lines = text.trim().split('\\n').join('\n').split('\n'); // <-- บรรทัดนี้ได้รับการแก้ไข
    const headers = lines[0].split(',').map(h => h.trim());
    return lines.slice(1).map(line => {
      // ใช้ regex เพื่อแบ่งตาม comma ที่ไม่ได้อยู่ในเครื่องหมายคำพูด (")
      const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
      let obj = {};
      headers.forEach((header, i) => {
        let value = values[i] ? values[i].trim() : '';
        // ลบเครื่องหมายคำพูด (") ที่ครอบอยู่
        if (value.startsWith('"') && value.endsWith('"')) {
            value = value.substring(1, value.length - 1);
        }
        obj[header] = value;
      });
      return obj;
    }).filter(obj => Object.keys(obj).length > 0 && obj[headers[0]] !== ''); // กรองแถวว่าง
  }
  
  function parseDate(str) {
    if (!str) return null;
    const [date, time] = str.split(' ');
    const [year, month, day] = date.split('-').map(Number);
    if (!time) return new Date(year, month - 1, day);
    const [hours, minutes] = time.split(':').map(Number);
    return new Date(year, month - 1, day, hours, minutes);
  }

  function debounce(func, delay) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  }

  function render(items) {
    if (items.length === 0) {
      grid.innerHTML = '<div class="loader">ไม่พบสินค้าที่ตรงกับเงื่อนไข</div>';
      return;
    }
    const placeholderImg = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect width="100" height="100" fill="%23222a33"/%3E%3Ctext x="50" y="55" font-family="sans-serif" font-size="14" fill="%2393a1b3" text-anchor="middle"%3ENo Image%3C/text%3E%3C/svg%3E';

    grid.innerHTML = items.map(it => {
      const isSold = (it["สถานะประกาศ (active|hidden|sold)"] || '').toLowerCase() === 'sold';
      const isHidden = (it["สถานะประกาศ (active|hidden|sold)"] || '').toLowerCase() === 'hidden';
      if (isHidden && status.value !== 'hidden') return ''; // ซ่อนรายการที่สถานะเป็น hidden ยกเว้นจะเลือกฟิลเตอร์สถานะ hidden

      const price = parseInt(it["ราคา (THB)"], 10);
      
      let img = it["ลิงก์รูปภาพหลัก"];
      if (!img) {
          const extraImgs = it["ลิงก์รูปภาพเพิ่มเติม (คั่นด้วย ,)"];
          if (extraImgs) {
              img = extraImgs.split(',')[0].trim();
          }
      }

      const fbUrl = it["ลิงก์โพสต์ Facebook (ถ้ามี)"];
      const buyBtnType = it["ปุ่มสั่งซื้อให้เด้งไปที่ (facebook|line|custom_url)"];
      let buyUrl = "#";
      if(buyBtnType === 'facebook') {
        buyUrl = "https://m.me/justcomth";
      } else if (buyBtnType === 'line') {
        buyUrl = "https://line.me/ti/p/~YOUR_LINE_ID"; // <-- TODO: Add your line ID
      } else if (buyBtnType === 'custom_url') {
        buyUrl = it["ลิงก์ปลายทางปุ่มสั่งซื้อ (ถ้าเลือก custom_url ให้ใส่ที่นี่)"];
      }

      return `
        <div class="item ${isSold ? 'sold' : ''}">
          ${isSold ? '<div class="badge">ขายแล้ว</div>' : (isHidden ? '<div class="badge" style="background:gray;">ซ่อนอยู่</div>' : '')}
          <div class="img">
            <img src="${img || placeholderImg}" alt="${it['ชื่อสินค้า']}" loading="lazy" onerror="this.onerror=null;this.src='${placeholderImg}';">
          </div>
          <div class="body">
            <h3 class="name">${it['ชื่อสินค้า']}</h3>
            <p class="spec">${it['สเปกย่อย (VRAM/ขนาด/สี ฯลฯ)'] || '&nbsp;'}</p>
            <div class="price">${price > 0 ? price.toLocaleString() + ' <span>บาท</span>' : 'สอบถาม'}</div>
          </div>
          <div class="foot">
            ${fbUrl ? `<a href="${fbUrl}" target="_blank" class="details">รายละเอียด</a>` : ''}
            <a href="${buyUrl}" target="_blank" class="buy">สั่งซื้อ</a>
          </div>
        </div>
      `;
    }).join('');
  }

  function applyFilters() {
    const qv = q.value.trim().toLowerCase();
    const cv = cat.value.trim();
    const sv = status.value.trim();
    let items = [...ALL_ITEMS];

    if (qv) {
      items = items.filter(it => {
        const hay = [it["ชื่อสินค้า"], it["ยี่ห้อ/แบรนด์"], it["รุ่นย่อย"], it["หมวดหมู่"], it["แท็ก (คั่นด้วย ,)"], it["SKU"]].join(" ").toLowerCase();
        return hay.includes(qv);
      });
    }
    
    // กรองตามสถานะที่เลือก
    if (sv) {
        items = items.filter(it => (it["สถานะประกาศ (active|hidden|sold)"] || "").toLowerCase() === sv);
    } else {
        // ถ้าไม่ได้เลือกสถานะใดๆ ให้แสดงเฉพาะ active และ sold (ซ่อน hidden ออกไปก่อน)
        items = items.filter(it => (it["สถานะประกาศ (active|hidden|sold)"] || "").toLowerCase() !== 'hidden');
    }
    
    if (cv) items = items.filter(it => (it["หมวดหมู่"] || "") === cv);
    
    // Sort: sold items to the end -> latest update first -> price
    items.sort((a, b) => {
      const sa = (a["สถานะประกาศ (active|hidden|sold)"] || "").toLowerCase() === "sold" ? 1 : 0;
      const sb = (b["สถานะประกาศ (active|hidden|sold)"] || "").toLowerCase() === "sold" ? 1 : 0;
      if (sa !== sb) return sa - sb;

      const da = parseDate(a["อัปเดตล่าสุด (YYYY-MM-DD HH:MM)"]) || parseDate(a["วันที่รับของ (YYYY-MM-DD)"]);
      const db = parseDate(b["อัปเดตล่าสุด (YYYY-MM-DD HH:MM)"]) || parseDate(b["วันที่รับของ (YYYY-MM-DD)"]);
      if (da && db) {
        if (db > da) return 1;
        if (db < da) return -1;
      }

      const pa = parseInt(a["ราคา (THB)"], 10) || 0;
      const pb = parseInt(b["ราคา (THB)"], 10) || 0;
      return pb - pa;
    });

    render(items);
  }
  
  function setupCategories(items) {
      const categories = [...new Set(items.map(it => it['หมวดหมู่']).filter(Boolean))];
      cat.innerHTML = '<option value="">ทุกหมวดหมู่</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
      
      catList.innerHTML = '';
      const allBtn = document.createElement('button');
      allBtn.className = 'cat-btn active';
      allBtn.textContent = 'ทั้งหมด';
      allBtn.onclick = () => {
          cat.value = '';
          applyFilters();
          document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
          allBtn.classList.add('active');
      };
      catList.appendChild(allBtn);

      categories.forEach(c => {
          const btn = document.createElement('button');
          btn.className = 'cat-btn';
          btn.textContent = c;
          btn.onclick = () => {
              cat.value = c;
              applyFilters();
              document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
          };
          catList.appendChild(btn);
      });
  }

  async function main() {
    try {
      const res = await fetch(CSV_URL);
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
      const text = await res.text();
      ALL_ITEMS = parseCSV(text);
      loader.style.display = 'none';
      setupCategories(ALL_ITEMS);
      applyFilters();

      q.addEventListener('input', debounce(applyFilters, 300));
      cat.addEventListener('change', applyFilters);
      status.addEventListener('change', applyFilters);

    } catch (error) {
      loader.innerHTML = `เกิดข้อผิดพลาดในการโหลดไฟล์ CSV: <br>${error.message}`;
      console.error("Failed to load or parse CSV:", error);
    }
  }

  main();
</script>

</body>
</html>