<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>JUST COM ‚Äî Diagnostic</title>
<style>
body{background:#0b0e11;color:#e6e6e6;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;margin:0}
#debug{position:sticky;top:0;background:#111;border-bottom:1px solid #333;padding:10px 12px;white-space:pre-wrap;font:12px/1.4 ui-monospace,Menlo,Consolas,monospace}
#debug b{color:#9ef}
#grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;padding:16px}
.card{position:relative;border:1px solid #222;border-radius:12px;overflow:hidden;background:#12151a}
.card .thumb{width:100%;height:180px;object-fit:cover;background:#0f1217}
.card .ct{padding:10px 12px}
.title{font-weight:600;margin:4px 0 6px}
.badge{display:inline-block;background:#1f2430;color:#cfe;padding:2px 8px;border-radius:999px;font-size:12px;margin-right:6px}
.price{font-weight:700;margin:4px 0 2px}
#empty{padding:32px;text-align:center;color:#aaa}
</style>
</head>
<body>
<div id="debug"><b>Debug:</b> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...</div>
<div id="empty" style="display:none">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...</div>
<div id="grid"></div>

<script>
const CONFIG={mode:"csv",csvPath:"data/justcom_inventory.csv",gsheetCsvUrl:""};

function log(){ const el=document.getElementById('debug'); el.textContent += "\\n" + Array.from(arguments).join(" "); }
function csvToArray(str,delim=","){
  const rows=str.split("\\n").filter(x=>x.trim().length);
  if(!rows.length) return [];
  const headers=rows.shift().split(delim).map(h=>h.trim());
  return rows.map(row=>{
    const cols=[]; let cur="", inQ=false;
    for(let i=0;i<row.length;i++){ const c=row[i];
      if(c=='"'){ inQ=!inQ; }
      else if(c===delim && !inQ){ cols.push(cur); cur=""; }
      else{ cur+=c; }
    }
    cols.push(cur);
    const obj={}; headers.forEach((h,i)=>obj[h]=(cols[i]??"").trim());
    return obj;
  });
}
function listify(s){
  if(!s) return [];
  const raw=String(s).trim().replace(/^["']|["']$/g,"");
  return raw.split(/[,Ôºå„ÄÅ\\n]+/).map(x=>x.trim()).filter(Boolean);
}
function render(items){
  const grid=document.getElementById('grid');
  const empty=document.getElementById('empty');
  grid.innerHTML="";
  if(!items.length){ empty.style.display="block"; empty.textContent="‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô CSV"; return; }
  empty.style.display="none";
  items.forEach(item=>{
    if((item["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® (active|hidden|sold)"]||"").toLowerCase()==="hidden") return;
    const imgs=[ item["‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å"], ...listify(item["‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ,)"]) ].filter(Boolean);
    const cover=imgs[0]||"";
    const price=item["‡∏£‡∏≤‡∏Ñ‡∏≤ (THB)"]? Number(item["‡∏£‡∏≤‡∏Ñ‡∏≤ (THB)"]).toLocaleString('th-TH')+" ‡∏ö‡∏≤‡∏ó":"‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤";
    const card=document.createElement('div'); card.className='card';
    card.innerHTML = `${cover?`<img class="thumb" src="${cover}" alt="">`:`<div class="thumb"></div>`}
      <div class="ct">
        <div class="title">${item["‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"]||item["‡∏£‡∏∏‡πà‡∏ô‡∏¢‡πà‡∏≠‡∏¢"]||item["SKU"]||"‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠"}</div>
        <div class="price">${price}</div>
        <div class="badge">üñºÔ∏è ${imgs.length} ‡∏£‡∏π‡∏õ</div>
      </div>`;
    grid.appendChild(card);
  });
}
async function tryFetch(u){
  const full = u + (u.includes("?")?"&":"?") + "v=" + Date.now();
  log("‚ÜóÔ∏è fetch:", full);
  const res = await fetch(full, {cache:"no-store"});
  log("   status:", res.status, res.statusText);
  if(!res.ok) throw new Error("HTTP "+res.status);
  const text = await res.text();
  log("   bytes:", text.length);
  if(!text.trim()) throw new Error("empty file");
  return text;
}
async function boot(){
  try{
    const candidates=[CONFIG.csvPath, "./justcom_inventory.csv"];
    let text=null, used="";
    for(const c of candidates){
      try{ text = await tryFetch(c); used=c; break; }
      catch(e){ log("‚ùå fail:", c, "->", e.message); }
    }
    if(!text){ document.getElementById('empty').style.display="block"; document.getElementById('empty').textContent="‡πÇ‡∏´‡∏•‡∏î CSV ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"; return; }
    log("‚úÖ CSV loaded from:", used);
    const head = text.split("\\n").slice(0,3).join("\\n");
    log("\\n<b>HEAD(3):</b>\\n"+head+"\\n");
    const arr = csvToArray(text);
    log("<b>Parsed:</b>", Array.isArray(arr)?arr.length+" rows":typeof arr);
    if(arr.length){ log("<b>Columns:</b>", Object.keys(arr[0]||{}).join(" | ")); }
    render(arr);
  }catch(err){
    log("üí• Error:", err.message);
    const empty=document.getElementById('empty'); empty.style.display="block"; empty.textContent="‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "+err.message;
  }
}
boot();
</script>
</body>
</html>
